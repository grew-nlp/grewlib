
PRE_FILES_DEP = libgrew_utils grew_ast
PRE_FILES_CMO = $(PRE_FILES_DEP:%=%.cmo)
PRE_FILES_CMX = $(PRE_FILES_DEP:%=%.cmx)

POST_FILES_DEP = grew_fs grew_edge grew_node grew_graph libgrew_types grew_command grew_rule grew_grs grew_html
POST_FILES_CMO = $(POST_FILES_DEP:%=%.cmo)
POST_FILES_CMX = $(POST_FILES_DEP:%=%.cmx)

FILES_DEP = $(PRE_FILES_DEP) $(POST_FILES_DEP)
FILES_CMI = $(FILES_DEP:%=%.cmi)
FILES_CMO = $(FILES_DEP:%=%.cmo)
FILES_CMX = $(FILES_DEP:%=%.cmx)

PARSER_DEP = parser_global lexer gr_grs_parser grew_parser
PARSER_CMI = $(PARSER_DEP:%=%.cmi)
PARSER_CMO = $(PARSER_DEP:%=%.cmo)
PARSER_CMX = $(PARSER_DEP:%=%.cmx)

.PHONY: parser

all: libgrew_utils.cmx grew_ast.cmx parser grew test
byte: libgrew_utils.cmo grew_ast.cmo parser.byte grew.byte test.byte


include ../config/Makefile



#executables

grew.byte: parser/parser_global.cmo parser_byte parser/grew_parser.cmo $(FILES_CMO) grew.ml
	$(OCAMLC) $(BYTE_FLAGS) -o grew.byte $(XML_LIGHT_BYTE) $(ANSITERMINAL_BYTE) $(LOG_BYTE)  \
	$(FILES_CMO) -I parser $(PARSER_CMO) \
	grew.ml

grew: parser/parser_global.cmx parser_opt parser/grew_parser.cmx $(FILES_CMX) grew.ml
	$(OCAMLOPT) $(OPT_FLAGS) -o grew str.cmxa unix.cmxa $(XML_LIGHT_OPT) $(ANSITERMINAL_OPT) $(LOG_OPT) \
	$(FILES_CMX) -I parser $(PARSER_CMX) \
	grew.ml

test.byte: parser/parser_global.cmo parser_byte parser/grew_parser.cmo $(FILES_CMO) $(FILES_CMI) test.ml
	$(OCAMLC) $(BYTE_FLAGS) -o test.byte $(XML_LIGHT_BYTE) $(ANSITERMINAL_BYTE) $(LOG_BYTE) \
	$(FILES_CMO) -I parser $(PARSER_CMO) \
	test.ml

test: parser/parser_global.cmx parser_opt parser/grew_parser.cmx $(FILES_CMX) $(FILES_CMI) test.ml
	$(OCAMLOPT) $(OPT_FLAGS) -o test str.cmxa unix.cmxa $(XML_LIGHT_OPT) $(ANSITERMINAL_OPT) $(LOG_OPT) \
	$(FILES_CMX) -I parser $(PARSER_CMX) \
	test.ml


#parser
parser_opt: 
	@make -C parser

parser_byte: 
	@make -C parser byte

# librairie

libgrew.mli : libgrew_types.mli libgrew_.mli
	rm -rf libgrew.mli
	touch libgrew.mli
	echo "(** Grew Library" > libgrew.mli
	echo "@author paul.masson\@inria.fr" >> libgrew.mli
	echo "@author bruno.guillaumme\@inria.fr" >> libgrew.mli
	echo "@version 1.0.0" >> libgrew.mli
	echo "*)" >> libgrew.mli
	echo "" >> libgrew.mli
	cat libgrew_types.mli >> libgrew.mli
	echo "" >> libgrew.mli
	echo "" >> libgrew.mli
	cat libgrew_.mli >> libgrew.mli

libgrew.cma : $(FILES_CMO) parser_byte libgrew.mli libgrew.ml
ifeq (@DEP2PICT@,no) 
	$(OCAMLC) -c -pp 'camlp4o pa_macro.cmo' $(BYTE_FLAGS) $(FILES_CMO) $(XML_LIGHT_BYTE) str.cma -I parser $(PARSER_CMO) libgrew.mli
	$(OCAMLC) -a -o libgrew.cma $(BYTE_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -linkall -I parser $(PRE_FILES_CMO) $(PARSER_CMO) $(POST_FILES_CMO) libgrew.ml
else
	$(OCAMLC) -c -pp 'camlp4o pa_macro.cmo -DDEP2PICT' $(BYTE_FLAGS) $(FILES_CMO) $(XML_LIGHT_BYTE) str.cma -I parser $(PARSER_CMO) libgrew.mli
	$(OCAMLC) -a -o libgrew.cma $(BYTE_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\" -DDEP2PICT' -linkall -I parser $(PRE_FILES_CMO) $(PARSER_CMO) $(POST_FILES_CMO) libgrew.ml
endif

libgrew.cmxa : $(FILES_CMX) parser_opt libgrew.mli libgrew.ml
ifeq (@DEP2PICT@,no)
	$(OCAMLOPT) -c -pp 'camlp4o pa_macro.cmo' $(OPT_FLAGS) $(FILES_CMX) $(XML_LIGHT_OPT) str.cmxa -I parser $(PARSER_CMX) libgrew.mli
	$(OCAMLOPT) -a -o libgrew.cmxa $(OPT_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -linkall -I parser $(PRE_FILES_CMX) $(PARSER_CMX) $(POST_FILES_CMX) libgrew.ml
else
	$(OCAMLOPT) -c -pp 'camlp4o pa_macro.cmo -DDEP2PICT' $(FILES_CMX) $(XML_LIGHT_OPT) str.cmxa -I parser $(PARSER_CMX) libgrew.mli
	$(OCAMLOPT) -a -o libgrew.cmxa -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\" -DDEP2PICT' -linkall -I parser $(PRE_FILES_CMX) $(PARSER_CMX) $(POST_FILES_CMX) libgrew.ml
endif

DEPENDS_DIR= -I parser

###### grew_core.ml ##############################################################
GREW_CORE_DEP = libgrew_types
GREW_CORE_CMI = $(GREW_CORE_DEP:%=%.cmi)
GREW_CORE_CMO = $(GREW_CORE_DEP:%=%.cmo)
GREW_CORE_CMX = $(GREW_CORE_DEP:%=%.cmx)

grew_core.cmi: $(GREW_CORE_CMI) grew_core.mli
	$(OCAMLC) -c grew_core.mli

grew_core.cmo: $(GREW_CORE_CMO) parser_byte grew_core.cmi grew_core.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) $(GREW_CORE_CMO) grew_core.ml

grew_core.cmx: $(GREW_CORE_CMX) parser_opt grew_core.cmi grew_core.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) $(GREW_CORE_CMX) grew_core.ml
################################################################################

###### libgrew_utils.ml ##############################################################
LIBGREW_UTILS_DEP = 
LIBGREW_UTILS_CMI = $(LIBGREW_UTILS_DEP:%=%.cmi)
LIBGREW_UTILS_CMO = $(LIBGREW_UTILS_DEP:%=%.cmo)
LIBGREW_UTILS_CMX = $(LIBGREW_UTILS_DEP:%=%.cmx)

libgrew_utils.cmi: $(LIBGREW_UTILS_CMI) libgrew_utils.mli
	$(OCAMLC) -c libgrew_utils.mli

libgrew_utils.cmo: $(LIBGREW_UTILS_CMO) libgrew_utils.cmi libgrew_utils.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) libgrew_utils.ml

libgrew_utils.cmx: $(LIBGREW_UTILS_CMX) libgrew_utils.cmi libgrew_utils.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) libgrew_utils.ml
################################################################################


###### grew_ast.ml ##############################################################
GREW_AST_DEP = libgrew_utils
GREW_AST_CMI = $(GREW_AST_DEP:%=%.cmi)
GREW_AST_CMO = $(GREW_AST_DEP:%=%.cmo)
GREW_AST_CMX = $(GREW_AST_DEP:%=%.cmx)

grew_ast.cmi: $(GREW_AST_CMI) grew_ast.mli
	$(OCAMLC) -c grew_ast.mli

grew_ast.cmo: $(GREW_AST_CMO) grew_ast.cmi grew_ast.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_ast.ml

grew_ast.cmx: $(GREW_AST_CMX) grew_ast.cmi grew_ast.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_ast.ml
################################################################################


###### grew_html.ml ##############################################################
GREW_HTML_DEP = libgrew_utils grew_ast grew_rule grew_grs
GREW_HTML_CMI = $(GREW_HTML_DEP:%=%.cmi)
GREW_HTML_CMO = $(GREW_HTML_DEP:%=%.cmo)
GREW_HTML_CMX = $(GREW_HTML_DEP:%=%.cmx)

grew_html.cmi: $(GREW_HTML_CMI) grew_html.mli
	$(OCAMLC) -c grew_html.mli

grew_html.cmo: $(GREW_HTML_CMO) grew_html.cmi grew_html.ml
	$(OCAMLC) $(BYTE_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -c $(DEPENDS_DIR) grew_html.ml

grew_html.cmx: $(GREW_HTML_CMX) grew_html.cmi grew_html.ml
	$(OCAMLOPT) $(OPT_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -c $(DEPENDS_DIR) grew_html.ml
################################################################################

###### grew_fs.ml ##############################################################
GREW_FS_DEP = libgrew_utils grew_ast
GREW_FS_CMI = $(GREW_FS_DEP:%=%.cmi)
GREW_FS_CMO = $(GREW_FS_DEP:%=%.cmo)
GREW_FS_CMX = $(GREW_FS_DEP:%=%.cmx)

grew_fs.cmi: $(GREW_FS_CMI) grew_fs.mli
	$(OCAMLC) -c grew_fs.mli

grew_fs.cmo: $(GREW_FS_CMO) grew_fs.cmi grew_fs.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_fs.ml

grew_fs.cmx: $(GREW_FS_CMX) grew_fs.cmi grew_fs.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_fs.ml
################################################################################


###### grew_edge.ml ##############################################################
GREW_EDGE_DEP = libgrew_utils grew_ast
GREW_EDGE_CMI = $(GREW_EDGE_DEP:%=%.cmi)
GREW_EDGE_CMO = $(GREW_EDGE_DEP:%=%.cmo)
GREW_EDGE_CMX = $(GREW_EDGE_DEP:%=%.cmx)

grew_edge.cmi: $(GREW_EDGE_CMI) grew_edge.mli
	$(OCAMLC) -c grew_edge.mli

grew_edge.cmo: $(GREW_EDGE_CMO) grew_edge.cmi grew_edge.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_edge.ml

grew_edge.cmx: $(GREW_EDGE_CMX) grew_edge.cmi grew_edge.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_edge.ml
################################################################################


###### grew_node.ml ##############################################################
GREW_NODE_DEP = libgrew_utils grew_ast grew_fs grew_edge
GREW_NODE_CMI = $(GREW_NODE_DEP:%=%.cmi)
GREW_NODE_CMO = $(GREW_NODE_DEP:%=%.cmo)
GREW_NODE_CMX = $(GREW_NODE_DEP:%=%.cmx)

grew_node.cmi: $(GREW_NODE_CMI) grew_node.mli
	$(OCAMLC) -c grew_node.mli

grew_node.cmo: $(GREW_NODE_CMO) grew_node.cmi grew_node.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_node.ml

grew_node.cmx: $(GREW_NODE_CMX) grew_node.cmi grew_node.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_node.ml
################################################################################


###### grew_graph.ml ##############################################################
GREW_GRAPH_DEP = libgrew_utils grew_ast grew_command grew_edge grew_fs grew_node 
GREW_GRAPH_CMI = $(GREW_GRAPH_DEP:%=%.cmi)
GREW_GRAPH_CMO = $(GREW_GRAPH_DEP:%=%.cmo)
GREW_GRAPH_CMX = $(GREW_GRAPH_DEP:%=%.cmx)

grew_graph.cmi: $(GREW_GRAPH_CMI) grew_graph.mli
	$(OCAMLC) -c $(XML_LIGHT_BYTE) grew_graph.mli

grew_graph.cmo: $(GREW_GRAPH_CMO) grew_graph.cmi grew_graph.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) $(XML_LIGHT_BYTE) grew_graph.ml

grew_graph.cmx: $(GREW_GRAPH_CMX) grew_graph.cmi grew_graph.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) $(XML_LIGHT_OPT) grew_graph.ml
################################################################################


###### libgrew_types.ml ##############################################################
LIBGREW_TYPES_DEP = grew_graph 
LIBGREW_TYPES_CMI = $(LIBGREW_TYPES_DEP:%=%.cmi)
LIBGREW_TYPES_CMO = $(LIBGREW_TYPES_DEP:%=%.cmo)
LIBGREW_TYPES_CMX = $(LIBGREW_TYPES_DEP:%=%.cmx)

libgrew_types.cmi: $(LIBGREW_TYPES_CMI) libgrew_types.mli
	$(OCAMLC) -c libgrew_types.mli

libgrew_types.cmo: $(LIBGREW_TYPES_CMO) libgrew_types.cmi libgrew_types.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) libgrew_types.ml

libgrew_types.cmx: $(LIBGREW_TYPES_CMX) libgrew_types.cmi libgrew_types.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) libgrew_types.ml
################################################################################


###### grew_command.ml ##############################################################
GREW_COMMAND_DEP = libgrew_utils grew_ast grew_edge grew_fs
GREW_COMMAND_CMI = $(GREW_COMMAND_DEP:%=%.cmi)
GREW_COMMAND_CMO = $(GREW_COMMAND_DEP:%=%.cmo)
GREW_COMMAND_CMX = $(GREW_COMMAND_DEP:%=%.cmx)

grew_command.cmi: $(GREW_COMMAND_CMI) grew_command.mli
	$(OCAMLC) -c grew_command.mli

grew_command.cmo: $(GREW_COMMAND_CMO) grew_command.cmi grew_command.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_command.ml

grew_command.cmx: $(GREW_COMMAND_CMX) grew_command.cmi grew_command.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_command.ml
################################################################################


###### grew_rule.ml ##############################################################
GREW_RULE_DEP = libgrew_utils grew_ast grew_command grew_edge grew_fs grew_node libgrew_types grew_graph
GREW_RULE_CMI = $(GREW_RULE_DEP:%=%.cmi)
GREW_RULE_CMO = $(GREW_RULE_DEP:%=%.cmo)
GREW_RULE_CMX = $(GREW_RULE_DEP:%=%.cmx)

grew_rule.cmi: $(GREW_RULE_CMI) grew_rule.mli
	$(OCAMLC) -c grew_rule.mli

grew_rule.cmo: $(GREW_RULE_CMO) grew_rule.cmi grew_rule.ml
ifeq (@DEP2PICT@,no)
	$(OCAMLC) -pp 'camlp4o pa_macro.cmo' $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_rule.ml
else
	$(OCAMLC) -pp 'camlp4o pa_macro.cmo -DDEP2PICT' $(BYTE_FLAGS) -c $(DEPENDS_DIR) $(DEP2PICT_BYTE) grew_rule.ml
endif

grew_rule.cmx: $(GREW_RULE_CMX) grew_rule.cmi grew_rule.ml
ifeq (@DEP2PICT@,no)
	$(OCAMLOPT) -pp 'camlp4o pa_macro.cmo' $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_rule.ml
else
	$(OCAMLOPT) -pp 'camlp4o pa_macro.cmo -DDEP2PICT' $(OPT_FLAGS) -c $(DEPENDS_DIR) $(DEP2PICT_OPT) grew_rule.ml
endif
################################################################################


###### grew_grs.ml ##############################################################
GREW_GRS_DEP = libgrew_utils grew_edge libgrew_types grew_graph grew_rule
GREW_GRS_CMI = $(GREW_GRS_DEP:%=%.cmi)
GREW_GRS_CMO = $(GREW_GRS_DEP:%=%.cmo)
GREW_GRS_CMX = $(GREW_GRS_DEP:%=%.cmx)

grew_grs.cmi: $(GREW_GRS_CMI) grew_grs.mli
	$(OCAMLC) -c grew_grs.mli

grew_grs.cmo: parser_byte $(GREW_GRS_CMO) grew_grs.cmi grew_grs.ml
	$(OCAMLC) $(BYTE_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -c $(DEPENDS_DIR) grew_grs.ml

grew_grs.cmx: parser_opt $(GREW_GRS_CMX) grew_grs.cmi grew_grs.ml
	$(OCAMLOPT) $(OPT_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -c $(DEPENDS_DIR) grew_grs.ml
################################################################################

# others

dep:
	rm depend
	ocamldep *.ml* > depend


clean: 
	@make -C parser clean
	rm -rf *.cmi *.cmo *.cmxa *.cma *.cmx *.o *.annot
	rm -f grew grew.byte
	rm -f test test.byte
	rm -f *.nf *.png *.html
	rm -f libgrew.mli

purge_makefile:
	@make -C parser purge
	@make purge

doc:
	rm libgrew.mli
	@make libgrew.mli
	mkdir -p ../doc
	ocamldoc -html -d ../doc libgrew.mli
