
PRE_FILES_DEP = grew_base grew_types grew_ast
PRE_FILES_CMO = $(PRE_FILES_DEP:%=%.cmo)
PRE_FILES_CMX = $(PRE_FILES_DEP:%=%.cmx)

POST_FILES_DEP = grew_fs grew_edge grew_node grew_graph libgrew_types grew_command grew_rule grew_grs grew_html
POST_FILES_CMO = $(POST_FILES_DEP:%=%.cmo)
POST_FILES_CMX = $(POST_FILES_DEP:%=%.cmx)

FILES_DEP = $(PRE_FILES_DEP) $(POST_FILES_DEP)
FILES_CMI = $(FILES_DEP:%=%.cmi)
FILES_CMO = $(FILES_DEP:%=%.cmo)
FILES_CMX = $(FILES_DEP:%=%.cmx)

PARSER_DEP = parser_global lexer gr_grs_parser grew_parser
PARSER_CMI = $(PARSER_DEP:%=%.cmi)
PARSER_CMO = $(PARSER_DEP:%=%.cmo)
PARSER_CMX = $(PARSER_DEP:%=%.cmx)

.PHONY: parser

all: grew_base.cmx grew_ast.cmx parser grew test
byte: grew_base.cmo grew_ast.cmo parser.byte grew.byte test.byte

include ../config/Makefile

#parser
parser_opt:
	@make -C parser

parser_byte:
	@make -C parser byte

libgrew.cma : $(FILES_CMO) parser_byte libgrew.mli libgrew.ml
ifeq (@DEP2PICT@,no)
	$(OCAMLC) -c -pp 'camlp4o pa_macro.cmo' $(BYTE_FLAGS) $(FILES_CMO) $(XML_LIGHT_BYTE) str.cma -I parser $(PARSER_CMO) libgrew.mli
	$(OCAMLC) -a -o libgrew.cma $(BYTE_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -linkall -I parser $(LOG_DIR) $(PRE_FILES_CMO) $(PARSER_CMO) $(POST_FILES_CMO) libgrew.ml
else
	$(OCAMLC) -c -pp 'camlp4o pa_macro.cmo -DDEP2PICT' $(BYTE_FLAGS) $(FILES_CMO) $(XML_LIGHT_BYTE) str.cma -I parser $(PARSER_CMO) libgrew.mli
	$(OCAMLC) -a -o libgrew.cma $(BYTE_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\" -DDEP2PICT' -linkall -I parser $(LOG_DIR) $(DEP2PICT_DIR) $(PRE_FILES_CMO) $(PARSER_CMO) $(POST_FILES_CMO) libgrew.ml
endif

libgrew.cmxa : $(FILES_CMX) parser_opt libgrew.mli libgrew.ml
ifeq (@DEP2PICT@,no)
	$(OCAMLOPT) -c -pp 'camlp4o pa_macro.cmo' $(OPT_FLAGS) $(FILES_CMX) $(LOG_OPT) $(XML_LIGHT_OPT) str.cmxa -I parser $(PARSER_CMX) libgrew.mli
	$(OCAMLOPT) -a -o libgrew.cmxa $(OPT_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -linkall -I parser $(LOG_DIR) $(PRE_FILES_CMX) $(PARSER_CMX) $(POST_FILES_CMX) libgrew.ml
else
	$(OCAMLOPT) -c -pp 'camlp4o pa_macro.cmo -DDEP2PICT' $(FILES_CMX) $(XML_LIGHT_OPT) str.cmxa -I parser $(PARSER_CMX) libgrew.mli
	$(OCAMLOPT) -a -o libgrew.cmxa -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\" -DDEP2PICT' -linkall -I parser $(LOG_DIR) $(DEP2PICT_DIR) $(PRE_FILES_CMX) $(PARSER_CMX) $(POST_FILES_CMX) libgrew.ml
endif

DEPENDS_DIR= -I parser $(LOG_DIR)

###### grew_base.ml ##############################################################
GREW_UTILS_DEP =
GREW_UTILS_CMI = $(GREW_UTILS_DEP:%=%.cmi)
GREW_UTILS_CMO = $(GREW_UTILS_DEP:%=%.cmo)
GREW_UTILS_CMX = $(GREW_UTILS_DEP:%=%.cmx)

grew_base.cmi: $(GREW_UTILS_CMI) grew_base.mli
	$(OCAMLC) -c grew_base.mli

grew_base.cmo: $(GREW_UTILS_CMO) grew_base.cmi grew_base.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_base.ml

grew_base.cmx: $(GREW_UTILS_CMX) grew_base.cmi grew_base.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_base.ml
################################################################################

###### grew_types.ml ##############################################################
GREW_UTILS_DEP = grew_base
GREW_UTILS_CMI = $(GREW_UTILS_DEP:%=%.cmi)
GREW_UTILS_CMO = $(GREW_UTILS_DEP:%=%.cmo)
GREW_UTILS_CMX = $(GREW_UTILS_DEP:%=%.cmx)

grew_types.cmi: $(GREW_UTILS_CMI) grew_types.mli
	$(OCAMLC) -c grew_types.mli

grew_types.cmo: $(GREW_UTILS_CMO) grew_types.cmi grew_types.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_types.ml

grew_types.cmx: $(GREW_UTILS_CMX) grew_types.cmi grew_types.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_types.ml
################################################################################

###### grew_ast.ml ##############################################################
GREW_AST_DEP = grew_base grew_types
GREW_AST_CMI = $(GREW_AST_DEP:%=%.cmi)
GREW_AST_CMO = $(GREW_AST_DEP:%=%.cmo)
GREW_AST_CMX = $(GREW_AST_DEP:%=%.cmx)

grew_ast.cmi: $(GREW_AST_CMI) grew_ast.mli
	$(OCAMLC) -c grew_ast.mli

grew_ast.cmo: $(GREW_AST_CMO) grew_ast.cmi grew_ast.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_ast.ml

grew_ast.cmx: $(GREW_AST_CMX) grew_ast.cmi grew_ast.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_ast.ml
################################################################################


###### grew_html.ml ##############################################################
GREW_HTML_DEP = grew_base grew_types grew_ast grew_rule grew_grs
GREW_HTML_CMI = $(GREW_HTML_DEP:%=%.cmi)
GREW_HTML_CMO = $(GREW_HTML_DEP:%=%.cmo)
GREW_HTML_CMX = $(GREW_HTML_DEP:%=%.cmx)

grew_html.cmi: $(GREW_HTML_CMI) grew_html.mli
	$(OCAMLC) -c grew_html.mli

grew_html.cmo: $(GREW_HTML_CMO) grew_html.cmi grew_html.ml
	$(OCAMLC) $(BYTE_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -c $(DEPENDS_DIR) grew_html.ml

grew_html.cmx: $(GREW_HTML_CMX) grew_html.cmi grew_html.ml
	$(OCAMLOPT) $(OPT_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -c $(DEPENDS_DIR) grew_html.ml
################################################################################

###### grew_fs.ml ##############################################################
GREW_FS_DEP = grew_base grew_types grew_ast
GREW_FS_CMI = $(GREW_FS_DEP:%=%.cmi)
GREW_FS_CMO = $(GREW_FS_DEP:%=%.cmo)
GREW_FS_CMX = $(GREW_FS_DEP:%=%.cmx)

grew_fs.cmi: $(GREW_FS_CMI) grew_fs.mli
	$(OCAMLC) -c grew_fs.mli

grew_fs.cmo: $(GREW_FS_CMO) grew_fs.cmi grew_fs.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_fs.ml

grew_fs.cmx: $(GREW_FS_CMX) grew_fs.cmi grew_fs.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_fs.ml
################################################################################


###### grew_edge.ml ##############################################################
GREW_EDGE_DEP = grew_base grew_types grew_ast
GREW_EDGE_CMI = $(GREW_EDGE_DEP:%=%.cmi)
GREW_EDGE_CMO = $(GREW_EDGE_DEP:%=%.cmo)
GREW_EDGE_CMX = $(GREW_EDGE_DEP:%=%.cmx)

grew_edge.cmi: $(GREW_EDGE_CMI) grew_edge.mli
	$(OCAMLC) -c grew_edge.mli

grew_edge.cmo: $(GREW_EDGE_CMO) grew_edge.cmi grew_edge.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_edge.ml

grew_edge.cmx: $(GREW_EDGE_CMX) grew_edge.cmi grew_edge.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_edge.ml
################################################################################


###### grew_node.ml ##############################################################
GREW_NODE_DEP = grew_base grew_types grew_ast grew_fs grew_edge
GREW_NODE_CMI = $(GREW_NODE_DEP:%=%.cmi)
GREW_NODE_CMO = $(GREW_NODE_DEP:%=%.cmo)
GREW_NODE_CMX = $(GREW_NODE_DEP:%=%.cmx)

grew_node.cmi: $(GREW_NODE_CMI) grew_node.mli
	$(OCAMLC) -c grew_node.mli

grew_node.cmo: $(GREW_NODE_CMO) grew_node.cmi grew_node.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_node.ml

grew_node.cmx: $(GREW_NODE_CMX) grew_node.cmi grew_node.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_node.ml
################################################################################


###### grew_graph.ml ##############################################################
GREW_GRAPH_DEP = grew_base grew_types grew_ast grew_command grew_edge grew_fs grew_node
GREW_GRAPH_CMI = $(GREW_GRAPH_DEP:%=%.cmi)
GREW_GRAPH_CMO = $(GREW_GRAPH_DEP:%=%.cmo)
GREW_GRAPH_CMX = $(GREW_GRAPH_DEP:%=%.cmx)

grew_graph.cmi: $(GREW_GRAPH_CMI) grew_graph.mli
	$(OCAMLC) -c $(XML_LIGHT_BYTE) grew_graph.mli

grew_graph.cmo: $(GREW_GRAPH_CMO) grew_graph.cmi grew_graph.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) $(XML_LIGHT_BYTE) grew_graph.ml

grew_graph.cmx: $(GREW_GRAPH_CMX) grew_graph.cmi grew_graph.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) $(XML_LIGHT_OPT) grew_graph.ml
################################################################################


###### libgrew_types.ml ##############################################################
LIBGREW_TYPES_DEP = grew_graph
LIBGREW_TYPES_CMI = $(LIBGREW_TYPES_DEP:%=%.cmi)
LIBGREW_TYPES_CMO = $(LIBGREW_TYPES_DEP:%=%.cmo)
LIBGREW_TYPES_CMX = $(LIBGREW_TYPES_DEP:%=%.cmx)

libgrew_types.cmi: $(LIBGREW_TYPES_CMI) libgrew_types.mli
	$(OCAMLC) -c libgrew_types.mli

libgrew_types.cmo: $(LIBGREW_TYPES_CMO) libgrew_types.cmi libgrew_types.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) libgrew_types.ml

libgrew_types.cmx: $(LIBGREW_TYPES_CMX) libgrew_types.cmi libgrew_types.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) libgrew_types.ml
################################################################################


###### grew_command.ml ##############################################################
GREW_COMMAND_DEP = grew_base grew_types grew_ast grew_edge grew_fs
GREW_COMMAND_CMI = $(GREW_COMMAND_DEP:%=%.cmi)
GREW_COMMAND_CMO = $(GREW_COMMAND_DEP:%=%.cmo)
GREW_COMMAND_CMX = $(GREW_COMMAND_DEP:%=%.cmx)

grew_command.cmi: $(GREW_COMMAND_CMI) grew_command.mli
	$(OCAMLC) -c grew_command.mli

grew_command.cmo: $(GREW_COMMAND_CMO) grew_command.cmi grew_command.ml
	$(OCAMLC) $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_command.ml

grew_command.cmx: $(GREW_COMMAND_CMX) grew_command.cmi grew_command.ml
	$(OCAMLOPT) $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_command.ml
################################################################################


###### grew_rule.ml ##############################################################
GREW_RULE_DEP = grew_base grew_types grew_ast grew_command grew_edge grew_fs grew_node libgrew_types grew_graph
GREW_RULE_CMI = $(GREW_RULE_DEP:%=%.cmi)
GREW_RULE_CMO = $(GREW_RULE_DEP:%=%.cmo)
GREW_RULE_CMX = $(GREW_RULE_DEP:%=%.cmx)

grew_rule.cmi: $(GREW_RULE_CMI) grew_rule.mli
	$(OCAMLC) -c grew_rule.mli

grew_rule.cmo: $(GREW_RULE_CMO) grew_rule.cmi grew_rule.ml
ifeq (@DEP2PICT@,no)
	$(OCAMLC) -pp 'camlp4o pa_macro.cmo' $(BYTE_FLAGS) -c $(DEPENDS_DIR) grew_rule.ml
else
	$(OCAMLC) -pp 'camlp4o pa_macro.cmo -DDEP2PICT' $(BYTE_FLAGS) -c $(DEPENDS_DIR) $(DEP2PICT_BYTE) grew_rule.ml
endif

grew_rule.cmx: $(GREW_RULE_CMX) grew_rule.cmi grew_rule.ml
ifeq (@DEP2PICT@,no)
	$(OCAMLOPT) -pp 'camlp4o pa_macro.cmo' $(OPT_FLAGS) -c $(DEPENDS_DIR) grew_rule.ml
else
	$(OCAMLOPT) -pp 'camlp4o pa_macro.cmo -DDEP2PICT' $(OPT_FLAGS) -c $(DEPENDS_DIR) $(DEP2PICT_OPT) grew_rule.ml
endif
################################################################################


###### grew_grs.ml ##############################################################
GREW_GRS_DEP = grew_base grew_types grew_edge libgrew_types grew_graph grew_rule
GREW_GRS_CMI = $(GREW_GRS_DEP:%=%.cmi)
GREW_GRS_CMO = $(GREW_GRS_DEP:%=%.cmo)
GREW_GRS_CMX = $(GREW_GRS_DEP:%=%.cmx)

grew_grs.cmi: $(GREW_GRS_CMI) grew_grs.mli
	$(OCAMLC) -c grew_grs.mli

grew_grs.cmo: parser_byte $(GREW_GRS_CMO) grew_grs.cmi grew_grs.ml
	$(OCAMLC) $(BYTE_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -c $(DEPENDS_DIR) grew_grs.ml

grew_grs.cmx: parser_opt $(GREW_GRS_CMX) grew_grs.cmi grew_grs.ml
	$(OCAMLOPT) $(OPT_FLAGS) -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\"' -c $(DEPENDS_DIR) grew_grs.ml
################################################################################

# others

dep:
	rm depend
	ocamldep *.ml* > depend


clean:
	@make -C parser clean
	rm -rf *.cmi *.cmo *.cmxa *.cma *.cmx *.o *.annot
	rm -f grew grew.byte
	rm -f test test.byte
	rm -f *.nf *.png *.html

purge_makefile:
	@make -C parser purge
	@make purge

doc:
	rm libgrew.mli
	@make libgrew.mli
	mkdir -p ../doc
	ocamldoc -html -d ../doc libgrew.mli
